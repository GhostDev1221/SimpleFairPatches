---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Jimmy.
--- DateTime: 2018/10/24 0024 14:25
---
SkillUtil = {}

function SkillUtil:checkTopAreaIsAir(position)
    local first = VectorUtil.newVector3i(position.x, position.y + 1, position.z)
    local second = VectorUtil.newVector3i(position.x, position.y + 2, position.z)
    if EngineWorld:getBlockId(first) == BlockID.AIR and
            EngineWorld:getBlockId(second) == BlockID.AIR then
        return true, first
    end
    return false, first
end

function SkillUtil:useEnderPearl(position, player)
    local range = 0
    local pos, isAir, tpPos
    pos = VectorUtil.newVector3i(position.x, position.y, position.z)
    isAir, tpPos = SkillUtil:checkTopAreaIsAir(pos)
    if isAir then
        player:teleportPos(tpPos)
        EngineWorld:addSimpleEffect("ender_pearl.effect", VectorUtil.toVector3(tpPos), player:getYaw(), 1000)
        return
    end
    range = 1
    while not isAir and range <= 1 do
        if not isAir then
            pos = VectorUtil.newVector3i(position.x - range, position.y, position.z)
            isAir, tpPos = SkillUtil:checkTopAreaIsAir(pos)
            if isAir then
                player:teleportPos(tpPos)
            end
        end
        if not isAir then
            pos = VectorUtil.newVector3i(position.x + range, position.y, position.z)
            isAir, tpPos = SkillUtil:checkTopAreaIsAir(pos)
            if isAir then
                player:teleportPos(tpPos)
            end
        end
        if not isAir then
            pos = VectorUtil.newVector3i(position.x, position.y, position.z - range)
            isAir, tpPos = SkillUtil:checkTopAreaIsAir(pos)
            if isAir then
                player:teleportPos(tpPos)
            end
        end
        if not isAir then
            pos = VectorUtil.newVector3i(position.x, position.y, position.z + range)
            isAir, tpPos = SkillUtil:checkTopAreaIsAir(pos)
            if isAir then
                player:teleportPos(tpPos)
            end
        end
        if not isAir then
            pos = VectorUtil.newVector3i(position.x + range, position.y, position.z - range)
            isAir, tpPos = SkillUtil:checkTopAreaIsAir(pos)
            if isAir then
                player:teleportPos(tpPos)
            end
        end
        if not isAir then
            pos = VectorUtil.newVector3i(position.x - range, position.y, position.z + range)
            isAir, tpPos = SkillUtil:checkTopAreaIsAir(pos)
            if isAir then
                player:teleportPos(tpPos)
            end
        end
        if not isAir then
            pos = VectorUtil.newVector3i(position.x + range, position.y, position.z + range)
            isAir, tpPos = SkillUtil:checkTopAreaIsAir(pos)
            if isAir then
                player:teleportPos(tpPos)
            end
        end
        if not isAir then
            pos = VectorUtil.newVector3i(position.x - range, position.y, position.z - range)
            isAir, tpPos = SkillUtil:checkTopAreaIsAir(pos)
            if isAir then
                player:teleportPos(tpPos)
            end
        end
        if not isAir then
            range = range + 1
        end
    end
    if not isAir then
        player:teleportPos(tpPos)
    end
    EngineWorld:addSimpleEffect("ender_pearl.effect", VectorUtil.toVector3(tpPos), player:getYaw(), 1000)
end

function SkillUtil:createExplosion(position, player, damage)
    if player:getEntityPlayer() ~= nil then
        local pos = VectorUtil.newVector3(position.x, position.y, position.z)
        EngineWorld:getWorld():createExplosion(player:getEntityPlayer(), player:getEntityPlayer(), pos, damage, false)
        EngineWorld:addSimpleEffect("explosion.effect", pos, player:getYaw(), 1000)
    end
end

function SkillUtil:useFrozenBall(area, c_player, duration)
    local players = PlayerManager:getPlayers()
    for _, player in pairs(players) do
        if player.isLife and player:getTeamId() ~= c_player:getTeamId() then
            if area:inArea(player:getPosition()) then
                player:setOnFrozen(duration)
            end
        end
    end
    local cars = GameManager:getCars()
    for entityId, car in pairs(cars) do
        if car:getTeamId() ~= c_player:getTeamId() then
            if area:inArea(car:getPosition()) then
                car:setOnFrozen(duration)
            end
        end
    end
end

return SkillUtil
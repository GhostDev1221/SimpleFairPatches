---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2018/12/22 17:22
---

require "process.BaseProcess"

PvpProcess = class("PvpProcess", BaseProcess)
PvpProcess.Index = 1

function PvpProcess:onTick(ticks)
    self.curTick = ticks
    self:updateSite(ticks)

    if self.curStatus == self.Status.Waitting then
        self.curStatus = self.Status.Running
        self.RunningTick = self.curTick
    end
end

function PvpProcess:assignTeam(player)
    player:setTeamId(self.Index)
    self.Index = self.Index + 1
    player.siteId = SiteConfig:addPlayerToFreeSites(player)
    player.chest = 1
end

function PvpProcess:updateSite(ticks)
    for _, site in pairs(SiteConfig.sites) do
        if site.playernum > 0 then
            site.process:onTick(ticks)
        end
    end
end

function PvpProcess:changeSite(player)
    local players = PlayerManager:getPlayerCount()
    local site = SiteConfig:getSitesById(player.siteId)
    if site == nil then
        return
    end
    site.process:sendSelectData(false)
    if players < GameConfig.maxPlayers then
        site:subPlayer(player)
        site.process:onPlayerQuit(player)
        player.siteId = SiteConfig:addPlayerToFreeSites(player)
    else
        EngineUtil.sendEnterOtherGame(player.rakssid, GameMatch.gameType, player.userId, player.cur_map_id)
    end
end

function PvpProcess:onPlayerQuit(player)
    local site = SiteConfig:getSitesById(player.siteId)
    if site == nil then
        return
    end
    site:subPlayer(player)
    site.process:onPlayerQuit(player)
    self:ifClose()
end

function PvpProcess:isRunning(id)
    if id == nil then
        return false
    end
    local site = SiteConfig:getSitesById(id)
    if site == nil then
        return false
    end
    return site.process:isRunning()
end

function PvpProcess:isSelect(id)
    local site = SiteConfig:getSitesById(id)
    if site == nil then
        return false
    end
    return site.process:isSelect()
end

function PvpProcess:updateChest(id)
    if id == nil then
        return
    end
    local site = SiteConfig:getSitesById(id)
    if site == nil then
        return
    end
    site:updateChest()
    site.process:sendSelectData(true)
end

function PvpProcess:onPlayerRespawn(player)
    local site = SiteConfig:getSitesById(player.siteId)
    if site == nil then
        return
    end
    site.process:teleGamePos(player)
end

function PvpProcess:isGameOver(player)
    local site = SiteConfig:getSitesById(player.siteId)
    if site == nil then
        return false
    end
    return site.process:isGameOver()
end

return PvpProcess
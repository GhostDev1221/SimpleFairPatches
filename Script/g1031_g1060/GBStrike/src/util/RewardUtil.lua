---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2018/9/30 9:47
---
RewardUtil = {}

function RewardUtil:sortPlayerRank()
    local players = PlayerManager:copyPlayers()
    table.sort(players, function(a, b)
        if a.kills ~= b.kills then
            return a.kills > b.kills
        end
        return a.userId > b.userId
    end)
    return players
end

function RewardUtil:getWinnerTeam()
    local winTeam = 0
    local lifeTeams = {}
    for _, team in pairs(GameMatch.Teams) do
        if team:isDeath() == false then
            lifeTeams[#lifeTeams + 1] = team
        end
    end
    if #lifeTeams == 1 then
        winTeam = lifeTeams[1].id
    elseif #lifeTeams > 1 then
        if lifeTeams[1].kills == lifeTeams[2].kills then
            return winTeam
        end
        table.sort(lifeTeams, function(a, b)
            return a.kills > b.kills
        end)
        winTeam = lifeTeams[1].id
    end
    return winTeam
end

function RewardUtil:doReward(players)
    for rank, player in pairs(players) do
        RewardManager:addRewardQueue(player.userId, rank)
    end
    RewardManager:getQueueReward(function(data)
        self:sendGameSettlement(self:getWinnerTeam())
    end)
end

function RewardUtil:doReport(players)
    for rank, player in pairs(players) do
        if player.isReport == false then
            ReportManager:reportUserData(player.userId, player.kills, rank, 1)
            player.isReport = true
        end
    end
end

function RewardUtil:sendGameSettlement(winTeam)
    local Players = self:sortPlayerRank()
    local players = {}
    for rank, player in pairs(Players) do
        players[rank] = self:newSettlementItem(player, rank, winTeam)
    end
    for rank, player in pairs(Players) do
        local result = {}
        result.players = players
        result.own = self:newSettlementItem(player, rank, winTeam)
        HostApi.sendGameSettlement(player.rakssid, json.encode(result), true)
    end
    for rank, player in pairs(Players) do
        UserExpManager:addUserExp(player.userId, winTeam == player:getTeamId(), 2)
    end
end

function RewardUtil:newSettlementItem(player, rank, winTeam)
    local item = {}
    item.name = player.name
    item.rank = rank
    item.points = player.scorePoints
    item.gold = player.gold
    item.available = player.available
    item.hasGet = player.hasGet
    item.vip = player.vip
    item.kills = player.kills
    item.adSwitch = player.adSwitch or 0
    if item.gold <= 0 then
        item.adSwitch = 0
    end
    if winTeam == 0 then
        item.isWin = 2
    else
        if winTeam == player:getTeamId() then
            item.isWin = 1
        else
            item.isWin = 0
        end
    end
    return item
end

return RewardUtil
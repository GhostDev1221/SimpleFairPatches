---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Jimmy.
--- DateTime: 2019/2/19 0019 14:38
---
RewardManager = {}
RewardManager.GameType = "g1001"
RewardManager.StandardNum = 10
RewardManager.StartPlayerCount = nil
RewardManager.StartPlayerTime = nil
RewardManager.WaitRewardCache = {}
RewardManager.RewardHistory = {}

function RewardManager:setGameType(GameType)
    self.GameType = GameType
end

function RewardManager:startGame()
    self.StartPlayerCount = PlayerManager:getPlayerCount()
    self.StartGameTime = os.time()
    self.RewardHistory = {}
    WebService:initGameId()
end

function RewardManager:getStartPlayerCount()
    return self.StartPlayerCount or PlayerManager:getPlayerCount()
end

function RewardManager:getStartGameTime()
    return self.StartGameTime or (os.time() - 60)
end

function RewardManager:isUserRewardFinish(userId)
    return self.RewardHistory[tostring(userId)]
end

function RewardManager:addRewardQueue(userId, rank)
    userId = tostring(userId)
    if self.RewardHistory[userId] then
        return
    end
    table.insert(self.WaitRewardCache, {
        userId = tonumber(userId),
        rank = rank
    })
    self.RewardHistory[userId] = true
end

function RewardManager:getQueueReward(func, ...)
    if #self.WaitRewardCache == 0 then
        func("", ...)
        return
    end
    local data = {}
    local startGameTime = RewardManager:getStartGameTime()
    local startPlayerCount = RewardManager:getStartPlayerCount()
    for _, cache in pairs(self.WaitRewardCache) do
        local item = {}
        item.userId = cache.userId
        item.gameId = self.GameType
        item.recordId = WebService.gameId
        item.rank = cache.rank or 10
        item.duration = os.time() - startGameTime
        item.standardNum = self.StandardNum
        item.totalNum = startPlayerCount
        item.startTime = os.date("%Y-%m-%d %H:%M:%S", startGameTime)
        table.insert(data, item)
    end
    self.WaitRewardCache = {}
    WebResponse:registerCallBack(func, WebService:GetBlockymodsRewardList(data), ...)
end

function RewardManager:getUserReward(userId, rank, func)
    if self.RewardHistory[tostring(userId)] then
        func()
        return
    end
    local startGameTime = RewardManager:getStartGameTime()
    local startPlayerCount = RewardManager:getStartPlayerCount()
    local data = {}
    data.duration = os.time() - startGameTime
    data.rank = rank or 10
    data.recordId = WebService.gameId
    data.standardNum = self.StandardNum
    data.totalNum = startPlayerCount
    data.startTime = os.date("%Y-%m-%d %H:%M:%S", startGameTime)
    WebResponse:registerCallBack(func, WebService:GetBlockymodsReward(userId, self.GameType, data))
    self.RewardHistory[tostring(userId)] = true
end

function RewardManager:getUserGoldReward(userId, gold, func)
    if self.RewardHistory[tostring(userId)] then
        func()
        return
    end
    WebResponse:registerCallBack(func, WebService:GetBlockymodsGoldReward(userId, self.GameType, gold))
    self.RewardHistory[tostring(userId)] = true
end

return RewardManager
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by work.
--- DateTime: 2018/7/5 10:41
---
require "config.BasicConfig"
require "data.GameGetEquip"
require "data.GameEquipBoxBuilder"
require "data.GamePotionEffect"

GameEquipBox = class()

function GameEquipBox:ctor(domain, config)
    self.domain = domain
    self.config = config
    self.builder = nil
    self.npc = nil
    self:onCreate()
end

--生成装备柜购买Npc
function GameEquipBox:onCreate()
    if self.domain == 0 then
        self.builder = GameEquipBoxBuilder.new(self, self.config.position, self.config.yaw, self.config.builderActor, self.config.name)
    else
        local pos = BasicConfig:getPosByBasic(self.domain.basicId, self.config.position)
        local yaw = BasicConfig:getYawByBasic(self.domain.basicId, self.config.yaw)
        self.builder = GameEquipBoxBuilder.new(self, pos, yaw, self.config.builderActor, self.config.name)
        self.domain:addEquipboxBuildingRecord(self.config.id)
    end
end

--玩家获得装备
function GameEquipBox:getEquip(player)
    if self.domain ~= 0 then
        if not self.domain:isDomainPlayer(player) then
            if not self.config.isShare then
                MsgSender.sendCenterTipsToTarget(player.rakssid, 2, Messages:occSpecialHas())
                return
            end
        end
    end
    if self.config.type == 1 then
        --套装
        if player.ownLastClothesId == 0 then
            for _, clothes in pairs(self.config.clothes) do
                if clothes.sex == player:getSex() or tonumber(clothes.sex) == 0 then
                    EngineWorld:changePlayerActor(player, clothes.name)
                    player.ownLastClothesId = self.config.id
                    self:changePlayerMaxHp(player)
                    break
                end
            end
        else
            if self.config.id ~= player.ownLastClothesId then
                for _, clothes in pairs(self.config.clothes) do
                    if clothes.sex == player:getSex() or tonumber(clothes.sex) == 0 then
                        EngineWorld:changePlayerActor(player, clothes.name)
                        player.ownLastClothesId = self.config.id
                        self:changePlayerMaxHp(player)
                        break
                    end
                end
            else
                MsgSender.sendCenterTipsToTarget(player.rakssid, 2, Messages:clothceHave())
            end
        end
    elseif self.config.type == 2 then
        --药水
        GamePotionEffect:hintPotionEffect(player, self.config.effect)
        if #player.ownPotionIds == 0 then
            GamePotionEffect:addPotionEffect(player, self.config)
        else
            local has = false
            for i, potionId in pairs(player.ownPotionIds) do
                if self.config.id == potionId then
                    has = true
                    break
                end
            end
            if not has then
                player.ownPotionIds[#player.ownPotionIds + 1] = self.config.id
                GamePotionEffect:addPotionEffect(player, self.config)
            end
        end
    elseif self.config.type == 3 then
        --武器
        local items = {}
        for i, v in pairs(self.config.enchantments) do
            local data = StringUtil.split(v, ":")
            data[1] = tonumber(data[1])
            data[2] = tonumber(data[2])
            table.insert(items, data)
        end

        if items[1][1] ~= 0 then
            if #player.ownEquipIds == 0 then
                player:addEchantmentsItem(self.config.armsId, 1, 0, items)
                player.ownWeaponDamage[tostring(self.config.armsId)] = self.config.damage
                player.ownEquipIds[#player.ownEquipIds + 1] = self.config.armsId
            else
                local has = false
                for i, EquipId in pairs(player.ownEquipIds) do
                    if self.config.armsId == EquipId then
                        has = true
                        MsgSender.sendCenterTipsToTarget(player.rakssid, 2, Messages:clothceHave())
                        break
                    end
                end
                if not has then
                    player:addEchantmentsItem(self.config.armsId, 1, 0, items)
                    player.ownWeaponDamage[tostring(self.config.armsId)] = self.config.damage
                    player.ownEquipIds[#player.ownEquipIds + 1] = self.config.armsId
                end
            end
        end

        if self.config.num > 1 then
            local curNum = player:getItemNumById(self.config.armsId)
            if curNum == 0 then
                player:addItem(self.config.armsId, self.config.num, 0)
                player.ownWeaponDamage[tostring(self.config.armsId)] = self.config.damage
                player.TNTDamage = self.config.damage
            else
                local num = math.max(0, (self.config.num - curNum))
                if num == 0 then
                    MsgSender.sendCenterTipsToTarget(player.rakssid, 2, Messages:clothceHave())
                end
                player:addItem(self.config.armsId, num, 0)
                player.ownWeaponDamage[tostring(self.config.armsId)] = self.config.damage
                player.TNTDamage = self.config.damage
            end
        else
            if #player.ownEquipIds == 0 then
                player:addItem(self.config.armsId, 1, 0)
                player.ownWeaponDamage[tostring(self.config.armsId)] = self.config.damage
                player:addItem(self.config.bullet.id, self.config.bullet.num, 0)
                player.ownEquipIds[#player.ownEquipIds + 1] = self.config.armsId
            else
                local has = false
                for i, EquipId in pairs(player.ownEquipIds) do
                    if self.config.armsId == EquipId then
                        has = true
                        local curNum = player:getItemNumById(self.config.bullet.id)
                        local num = math.max(0, (self.config.bullet.num - curNum))
                        player:addItem(self.config.bullet.id, num, 0)
                        break
                    end
                end
                if not has then
                    player:addItem(self.config.armsId, 1, 0)
                    player.ownWeaponDamage[tostring(self.config.armsId)] = self.config.damage
                    player:addItem(self.config.bullet.id, self.config.bullet.num, 0)
                    player.ownEquipIds[#player.ownEquipIds + 1] = self.config.armsId
                end
            end
        end

    elseif self.config.type == 4 then
        --技能物品
        if #player.ownEquipIds == 0 then
            player:addItem(self.config.armsId, 1, 0)
            player.ownEquipIds[#player.ownEquipIds + 1] = self.config.armsId
            MsgSender.sendCenterTipsToTarget(player.rakssid, 2, Messages:skillHave())
        else
            local has = false
            for i, EquipId in pairs(player.ownEquipIds) do
                if self.config.armsId == EquipId then
                    has = true
                    break
                end
            end
            if not has then
                player:addItem(self.config.armsId, 1, 0)
                player.ownEquipIds[#player.ownEquipIds + 1] = self.config.armsId
                MsgSender.sendCenterTipsToTarget(player.rakssid, 2, Messages:skillHave())
            end
        end
    end
end

function GameEquipBox:changePlayerMaxHp(player)
    player:changeMaxHealth((player.maxHealth - player.lastAddMaxHp) + self.config.clothesHp)
    player.maxHealth = (player.maxHealth - player.lastAddMaxHp) + self.config.clothesHp
    player.lastAddMaxHp = self.config.clothesHp
end

-- 领主
function GameEquipBox:getPlayer()
    return self.domain.player
end

function GameEquipBox:getPrice()
    return self.config.price
end

function GameEquipBox:buildEquipBox(pos, yaw)
    if self.domain ~= 0 then
        local m_pos = BasicConfig:getPosByBasic(self.domain.basicId, self.config.position)
        local m_yaw = BasicConfig:getYawByBasic(self.domain.basicId, self.config.yaw)
        self.domain.equipboxs[#self.domain.equipboxs] = GameGetEquip.new(self, m_pos, m_yaw, self.config.actor, self.config.equipEffect)
        self.domain:addBuildProgress(self.config.value)
    else
        self.npc = GameGetEquip.new(self, pos, yaw, self.config.actor, self.config.equipEffect)
    end
end

return GameEquipBox
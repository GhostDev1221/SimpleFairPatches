---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2018/8/24 18:50
---
CustomListener = {}

function CustomListener:init()
    ConsumeDiamondsEvent.registerCallBack(self.onConsumeDiamonds)
end

function CustomListener.onConsumeDiamonds(rakssid, isSuccess, message, extra)
    if isSuccess == false then
        return
    end
    local player = PlayerManager:getPlayerByRakssid(rakssid)
    if player == nil then
        return
    end
    if extra == "keepItem" then
        player.keepItemTimes = player.keepItemTimes + 1
        player:fillInvetory(player.inventory)
        return
    end

    local info = StringUtil.split(extra, "#")
    if info then
        local enchantmentQuick = tostring(info[1])
        local equipId = tonumber(info[2])
        local effectId = tonumber(info[3])
        local effectLevel = tonumber(info[4])
        
        if enchantmentQuick == "enchantmentQuick" then
            if effectId > 0 and effectLevel > 0 then
                local hasEquip = false
                local equipIndex = -1

                local inv = InventoryUtil:getPlayerInventoryInfo(player)
                local invPlayer = player:getInventory()
                if inv and inv.item then
                    for _, stack in pairs(inv.item) do

                        local isEnchantment = false

                        if invPlayer then
                            isEnchantment = invPlayer:isEnchantment(stack.stackIndex)
                        end

                        if stack.id == equipId and isEnchantment == false then
                            equipIndex = stack.stackIndex
                            hasEquip = true
                        end

                    end
                end

                if hasEquip and invPlayer then
                    if equipIndex >= 0 then
                        invPlayer:decrStackSize(equipIndex, 1)
                        player:addEchantmentItem(equipId, 1, 0, effectId, effectLevel)
                        player:sendOpenChantment(1)
                        return
                    end
                end
            end
        end
    end
end

return CustomListener
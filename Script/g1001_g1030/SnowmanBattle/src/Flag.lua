-- -
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by work.
--- DateTime: 2018/8/23 10:07
-- -
require "base.util.VectorUtil"

Flag = class()

function Flag:ctor(team, config)
    self.entityId = nil
    self.teamId = team
    self.config = config
    self.initPos = config.initPos
    self.yaw = config.yaw
    self.actor = config.actor
    self.name = config.name
    self.hp = config.hp
    self.rewardId = config.id
    self.num = config.num
    self.rewardHp = config.rewradHp
    self.isReward = false
    self:onCreake()
end

function Flag:onCreake()
    self.entityId = EngineWorld:addCreatureNpc(VectorUtil.newVector3(unpack(self.initPos)), 1001, self.yaw, self.actor, self.name)
    Match:onAddFlag(self)
end

function Flag:inSameTeam(teamId)
    return self.teamId == teamId
end

function Flag:attackedByPlayer(fromId, damage)
    self.hp = math.max(0, (self.hp - damage))

    if self.hp <= self.rewardHp then
        if self.isReward == false then
            self:onRewradToTeam(fromId)
        end
    end

    if self.hp == 0 then
        self:onRemove()
    end
end

function Flag:onRewradToTeam(fromId)
    self.isReward = true
    local fromer = PlayerManager:getPlayerByRakssid(fromId)
    local players = PlayerManager:getPlayers()
    for _, player in pairs(players) do
        if fromer.dynamicAttr.team == player.dynamicAttr.team then
            if (player.is_death == false) then
                player:AddItem(self.rewardId, self.num, 0)
            end
        end
        if (fromer.dynamicAttr.team == 1) then
            MsgSender.sendCenterTips(3, 1030011)
        else
            MsgSender.sendCenterTips(3, 1030012)
        end
    end
end

function Flag:onRemove()
    Match:onRemoveFlag(self)
end

return Flag